{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Agency Info Card -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="card-title">{{ agency.name }}</h2>
                        {% if not is_parent and parent_agency %}
                        <p class="text-muted">Parent Agency: <a
                                href="/agency-detail.html?id={{ parent_agency.slug }}">{{ parent_agency.name }}</a></p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-md-end">
                        {% if is_parent %}
                        <span class="badge bg-primary">Parent Agency</span>
                        {% else %}
                        <span class="badge bg-secondary">Child Agency</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Stats -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-4 mb-4 mb-md-0">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="stat-value">{{ "{:,}".format(word_count.word_count|default(0)) }}</h3>
                        <p class="stat-label">Total Words</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4 mb-md-0">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="stat-value">{{ "{:,}".format(corrections.total_corrections|default(0)) }}</h3>
                        <p class="stat-label">Total Corrections</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        {% if is_parent %}
                        <h3 class="stat-value">{{ child_agencies|length }}</h3>
                        <p class="stat-label">Child Agencies</p>
                        {% else %}
                        <h3 class="stat-value">{{ word_count.titles|default([])|length }}</h3>
                        <p class="stat-label">CFR Titles</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Title Distribution by Word Count -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Word Count by CFR Title</h5>
            </div>
            <div class="card-body">
                <div id="title-word-count-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <!-- Corrections Over Time -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Corrections Over Time</h5>
            </div>
            <div class="card-body">
                <div id="corrections-over-time-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    {% if is_parent and child_agencies %}
    <!-- Child Agencies Table -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Child Agencies</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Agency Name</th>
                                <th>Word Count</th>
                                <th>Corrections</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for child in child_agencies %}
                            <tr>
                                <td>{{ child.name }}</td>
                                <td>{{ "{:,}".format(child.word_count) }}</td>
                                <td>{{ "{:,}".format(child.corrections) }}</td>
                                <td>
                                    <a href="/agency-detail.html?id={{ child.slug }}"
                                        class="btn btn-sm btn-primary">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Title Details Table -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">CFR Title Details</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Title Number</th>
                                <th>Title Name</th>
                                <th>Word Count</th>
                                <th>Corrections</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if word_count.titles %}
                            {% for title_num, title_data in word_count.titles.items() %}
                            <tr>
                                <td>{{ title_num }}</td>
                                <td>{{ title_data.title_name }}</td>
                                <td>{{ "{:,}".format(title_data.word_count|default(0)) }}</td>
                                <td>{% if corrections.titles and title_num in corrections.titles %}
                                    {{ "{:,}".format(corrections.titles[title_num].total_corrections|default(0)) }}
                                    {% else %}
                                    0
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No title data available</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Process data passed from Flask with proper validation
    
    // Agency data
    var agencyData = {};
    try {
        agencyData = JSON.parse('{{ agency_json|safe }}');
    } catch (error) {
        console.error('Error parsing agency data:', error);
    }

    // Word count data
    var wordCountData = [];
    {% if word_count_json %}
    try {
        wordCountData = JSON.parse('{{ word_count_json|safe }}');
    } catch (error) {
        console.error('Error parsing word count data:', error);
    }
    {% endif %}

    // Corrections data
    var correctionsData = [];
    {% if corrections_json %}
    try {
        correctionsData = JSON.parse('{{ corrections_json|safe }}');
    } catch (error) {
        console.error('Error parsing corrections data:', error);
    }
    {% endif %}
    
    // Init charts if external function exists
    if (typeof initAgencyDetailCharts === 'function') {
        initAgencyDetailCharts(agencyData.slug);
    } else {
        // Fallback implementation for word count chart
        if (wordCountData.length > 0 && typeof Plotly !== 'undefined') {
            // Sort by word count (descending)
            wordCountData.sort((a, b) => b.wordCount - a.wordCount);

            // Get top 10 titles
            var top10Titles = wordCountData.slice(0, 10);

            var titleLabels = top10Titles.map(item => item.title);
            var titleValues = top10Titles.map(item => item.wordCount);

            var titleWordCountChart = document.getElementById('title-word-count-chart');
            if (titleWordCountChart) {
                Plotly.newPlot(titleWordCountChart, [{
                    x: titleLabels,
                    y: titleValues,
                    type: 'bar',
                    marker: {
                        color: '#0b3d91'
                    }
                }], {
                    margin: { t: 10, r: 10, b: 50, l: 50 },
                    yaxis: {
                        title: 'Word Count'
                    }
                });
            }
        }

        // Fallback implementation for corrections over time chart
        var correctionsOverTimeChart = document.getElementById('corrections-over-time-chart');
        if (correctionsData.length > 0 && correctionsOverTimeChart && typeof Plotly !== 'undefined') {
            // Sort corrections by year
            correctionsData.sort((a, b) => a.year - b.year);

            var years = correctionsData.map(item => item.year);
            var counts = correctionsData.map(item => item.count);

            Plotly.newPlot(correctionsOverTimeChart, [{
                x: years,
                y: counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: '#0b3d91',
                    width: 3
                },
                marker: {
                    size: 8,
                    color: '#0b3d91'
                }
            }], {
                margin: { t: 10, r: 10, b: 50, l: 50 },
                yaxis: {
                    title: 'Corrections'
                },
                xaxis: {
                    title: 'Year'
                }
            });
        }
    }
});
</script>
{% endblock %}