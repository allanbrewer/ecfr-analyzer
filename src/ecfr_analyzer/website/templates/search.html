{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Search Form -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Advanced Search</h5>
            </div>
            <div class="card-body">
                <form id="advanced-search-form" class="row g-3">
                    <div class="col-md-12">
                        <label for="search-query" class="form-label">Search Query</label>
                        <input type="text" class="form-control" id="search-query"
                            placeholder="Enter keywords, phrases, or specific text...">
                    </div>
                    <div class="col-md-4">
                        <label for="search-agency" class="form-label">Agency</label>
                        <select class="form-select" id="search-agency">
                            <option value="">All Agencies</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="search-title" class="form-label">CFR Title</label>
                        <select class="form-select" id="search-title">
                            <option value="">All Titles</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="search-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="search-date">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Filter by Category</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-dei">
                            <label class="form-check-label" for="filter-dei">Include DEI-related regulations</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-waste">
                            <label class="form-check-label" for="filter-waste">Include waste-related regulations</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-complex">
                            <label class="form-check-label" for="filter-complex">Include regulations with high
                                complexity</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Search Regulations</button>
                        <button type="reset" class="btn btn-outline-secondary">Reset Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Agency Search -->
    <div class="col-12 mb-4">
        <div class="search-container">
            <h2 class="text-center mb-4">Search Federal Agencies</h2>
            <form id="agency-search-form" class="search-bar">
                <input type="text" id="agency-search-input" placeholder="Enter agency name (e.g., 'Agriculture', 'Treasury', 'EPA')" 
                       class="form-control" required>
                <button type="submit" class="btn">
                    <i class="bi bi-search"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Agency Leaderboard -->
    <div class="col-12 mb-4">
        <h3 class="leaderboard-heading">Agency Efficiency Leaderboard</h3>
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Agency</th>
                                <th>Word Count</th>
                                <th>Corrections</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set agencies = [] %}
                            {% if hierarchy and hierarchy.agencies %}
                                {% for agency in hierarchy.agencies %}
                                    {% if agency.slug %}
                                        {% set _ = agencies.append(agency) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for agency in agencies[:10] %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ agency.name }}</td>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                        <td>
                                            <a href="/agency-detail.html?id={{ agency.slug }}" class="btn btn-sm btn-primary">View</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No agency data available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="col-12" id="search-results-section" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Search Results</h5>
                <span class="badge bg-light text-dark" id="result-count">0 results</span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="sort-results" class="form-label">Sort By</label>
                    <select class="form-select form-select-sm w-auto" id="sort-results">
                        <option value="relevance">Relevance</option>
                        <option value="date-desc">Date (Newest First)</option>
                        <option value="date-asc">Date (Oldest First)</option>
                        <option value="title-asc">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                    </select>
                </div>
                <div id="search-results-container">
                    <!-- Will be populated by JavaScript -->
                    <div class="text-center p-5">
                        <i class="bi bi-search fs-1 text-muted"></i>
                        <p class="mt-3">Enter your search query to find regulations</p>
                    </div>
                </div>
                <div id="search-pagination" class="d-flex justify-content-between align-items-center mt-4">
                    <button id="search-prev-page" class="btn btn-sm btn-outline-secondary" disabled>Previous</button>
                    <span id="search-page-indicator">Page 1</span>
                    <button id="search-next-page" class="btn btn-sm btn-outline-secondary" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agency Search Results -->
    <div class="col-12">
        <div id="agency-search-results" class="agency-search-results">
            <!-- Results will be populated by JavaScript -->
            <div class="alert alert-info">
                Enter an agency name in the search box above to find specific agencies.
            </div>
        </div>
    </div>

    <!-- No Results Message -->
    <div class="col-12" id="no-results-section" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-body text-center p-5">
                <i class="bi bi-emoji-frown fs-1 text-muted"></i>
                <h4 class="mt-3">No Results Found</h4>
                <p class="text-muted">We couldn't find any regulations matching your search criteria.</p>
                <p>Try modifying your search terms or removing some filters.</p>
            </div>
        </div>
    </div>

    <!-- Search History -->
    <div class="col-12 mt-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Recent Searches</h5>
            </div>
            <div class="card-body">
                <div id="search-history-container">
                    <!-- Will be populated by JavaScript -->
                    <p class="text-muted text-center" id="no-history-message">No recent searches</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Regulation Detail Modal -->
<div class="modal fade" id="regulation-detail-modal" tabindex="-1" aria-labelledby="regulation-modal-title"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regulation-modal-title">Regulation Detail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="regulation-modal-body">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="view-full-regulation" target="_blank">View on eCFR.gov</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="static/js/search.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize search functionality
        initSearchPage();

        // Load agency and title dropdowns
        loadAgencyDropdown('search-agency');
        loadTitleDropdown('search-title');

        // Load search history
        loadSearchHistory();

        // Handle search form submission
        document.getElementById('advanced-search-form').addEventListener('submit', function (event) {
            event.preventDefault();
            performSearch();
        });

        // Handle sort change
        document.getElementById('sort-results').addEventListener('change', function () {
            sortSearchResults(this.value);
        });

        // Handle pagination
        document.getElementById('search-prev-page').addEventListener('click', function () {
            changeSearchPage(-1);
        });

        document.getElementById('search-next-page').addEventListener('click', function () {
            changeSearchPage(1);
        });
    });
</script>
{% endblock %}