{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Time Period Selector -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Historical Corrections Analysis</h5>
            </div>
            <div class="card-body">
                <form id="time-period-form" class="row g-3">
                    <div class="col-md-4">
                        <label for="time-period-select" class="form-label">Select Time Period</label>
                        <select class="form-select" id="time-period-select">
                            <option value="all">All Available Years</option>
                            <option value="5">Last 5 Years</option>
                            <option value="3">Last 3 Years</option>
                            <option value="1">Last Year</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="agency-filter" class="form-label">Filter by Agency</label>
                        <select class="form-select" id="agency-filter">
                            <option value="all">All Agencies</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Corrections Over Time Chart -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Corrections Over Time</h5>
            </div>
            <div class="card-body">
                <div id="corrections-over-time-chart" style="height: 500px;"></div>
            </div>
        </div>
    </div>

    <!-- Corrections Statistics -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Correction Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="p-3 bg-primary bg-opacity-10 rounded me-3">
                                <i class="bi bi-pencil-square fs-1 text-primary"></i>
                            </div>
                            <div>
                                <h6 class="fw-normal text-muted mb-0">Total Corrections</h6>
                                <h4 id="total-corrections" class="mb-0">{{ stats.total_corrections|default('Loading...')
                                    }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="p-3 bg-success bg-opacity-10 rounded me-3">
                                <i class="bi bi-calendar-event fs-1 text-success"></i>
                            </div>
                            <div>
                                <h6 class="fw-normal text-muted mb-0">Avg. Per Year</h6>
                                <h4 id="avg-corrections-per-year" class="mb-0">{{
                                    stats.avg_per_year|default('Loading...') }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="p-3 bg-info bg-opacity-10 rounded me-3">
                                <i class="bi bi-graph-up fs-1 text-info"></i>
                            </div>
                            <div>
                                <h6 class="fw-normal text-muted mb-0">Peak Year</h6>
                                <h4 id="peak-correction-year" class="mb-0">{{ stats.peak_year|default('Loading...') }}
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="p-3 bg-warning bg-opacity-10 rounded me-3">
                                <i class="bi bi-building fs-1 text-warning"></i>
                            </div>
                            <div>
                                <h6 class="fw-normal text-muted mb-0">Top Agency</h6>
                                <h4 id="top-agency" class="mb-0">{{ stats.top_agency|default('Loading...') }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Parse corrections over time data from server
        var correctionsOverTimeData = JSON.parse('{{ corrections_over_time_json|safe }}');

        // Create the corrections over time chart
        if (correctionsOverTimeData && correctionsOverTimeData.length > 0) {
            var years = correctionsOverTimeData.map(function (item) {
                return item.year;
            });

            var corrections = correctionsOverTimeData.map(function (item) {
                return item.count;
            });

            var correctionsChart = document.getElementById('corrections-over-time-chart');
            if (correctionsChart && typeof Plotly !== 'undefined') {
                Plotly.newPlot(correctionsChart, [{
                    x: years,
                    y: corrections,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Corrections',
                    line: {
                        color: '#0b3d91',
                        width: 3
                    },
                    marker: {
                        size: 8,
                        color: '#0b3d91'
                    }
                }], {
                    margin: { t: 20, r: 20, b: 50, l: 50 },
                    xaxis: {
                        title: 'Year'
                    },
                    yaxis: {
                        title: 'Number of Corrections'
                    }
                });
            }
        }

        // Populate agency filter
        var agencyFilter = document.getElementById('agency-filter');
        if (agencyFilter) {
            var agencyHierarchy = JSON.parse('{{ agency_hierarchy_json|safe }}');

            if (agencyHierarchy && agencyHierarchy.agencies) {
                agencyHierarchy.agencies.forEach(function (agency) {
                    var option = document.createElement('option');
                    option.value = agency.slug;
                    option.textContent = agency.name;
                    agencyFilter.appendChild(option);
                });
            }
        }

        // Handle filter form submission
        var filterForm = document.getElementById('time-period-form');
        if (filterForm) {
            filterForm.addEventListener('submit', function (e) {
                e.preventDefault();
                // Logic to filter data would go here
                // This would typically make an AJAX request to get filtered data
                alert('Filter functionality would be implemented here.');
            });
        }
    });
</script>
{% endblock %}